esphome:
  name: multiir
  # on_boot és vàlid en ESPHome (va dins "esphome:", no "esp32:")

  on_boot:
    priority: -100
    then:
      - lambda: |-
          // Estableix hostname per ETH abans del DHCP
          ETH.setHostname("multiir");

          // Llegeix valors guardats per IP estàtica
          auto ip  = IPAddress(id(ip1).state, id(ip2).state, id(ip3).state, id(ip4).state);
          auto gw  = IPAddress(id(gw1).state, id(gw2).state, id(gw3).state, id(gw4).state);
          auto nm  = IPAddress(id(nm1).state, id(nm2).state, id(nm3).state, id(nm4).state);
          auto d1  = IPAddress(id(dns1_1).state, id(dns1_2).state, id(dns1_3).state, id(dns1_4).state);
          auto d2  = IPAddress(id(dns2_1).state, id(dns2_2).state, id(dns2_3).state, id(dns2_4).state);

          // Si tenim una IP vàlida, apliquem IP estàtica
          if (ip != IPAddress(0,0,0,0) && gw != IPAddress(0,0,0,0) && nm != IPAddress(0,0,0,0)) {
            ETH.config(ip, gw, nm, d1, d2);
          }

          // Subscripció a esdeveniments ETH (Arduino core)
          Network.onEvent({
            switch (event) {
              case ARDUINO_EVENT_ETH_CONNECTED:
                // Tanca l'AP quan el link ETH puja
                WiFi.softAPdisconnect(true);
                break;
              case ARDUINO_EVENT_ETH_DISCONNECTED:
                // Segons el flux que vols: reinicia i entra en AP
                ESP.restart();
                break;
              default:
                break;
            }
          });

          // En aquest punt (després d'un reinici amb el cable desconnectat) obrim l'AP
          // Obertura d'AP sense declarar component wifi:
          WiFi.mode(WIFI_AP);
          WiFi.softAP("multiir", "12345678"); // SSID / passwd

esp32:
  board: esp32dev
  framework:
    type: arduino

logger:
  level: DEBUG

api:
  encryption:
    key: !secret api_key

ota:
  - platform: esphome

mdns:

web_server:
  port: 80
  version: 3
  local: true  # JS/CSS locals per funcionar sense internet
  # sense auth per petició teva (es pot afegir)

ethernet:
  type: LAN8720
  mdc_pin: GPIO23
  mdio_pin: GPIO18
  clk:
    pin: GPIO0
    mode: CLK_EXT_IN
  phy_addr: 1
  power_pin: GPIO16
  # DHCP per defecte; si guardes IP, s'aplica amb ETH.config() a on_boot

# --- Entrades per IP/màscara/gateway/DNS (persistents) ---
number:
  # IP
  - platform: template
    name: "IP o1"    ; id: ip1 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "IP o2"    ; id: ip2 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "IP o3"    ; id: ip3 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "IP o4"    ; id: ip4 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true

  # Màscara
  - platform: template
    name: "Mask o1"  ; id: nm1 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "Mask o2"  ; id: nm2 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "Mask o3"  ; id: nm3 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "Mask o4"  ; id: nm4 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true

  # Gateway
  - platform: template
    name: "GW o1"    ; id: gw1 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "GW o2"    ; id: gw2 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "GW o3"    ; id: gw3 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "GW o4"    ; id: gw4 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true

  # DNS1
  - platform: template
    name: "DNS1 o1"  ; id: dns1_1 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "DNS1 o2"  ; id: dns1_2 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "DNS1 o3"  ; id: dns1_3 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "DNS1 o4"  ; id: dns1_4 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true

  # DNS2 (opcional)
  - platform: template
    name: "DNS2 o1"  ; id: dns2_1 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "DNS2 o2"  ; id: dns2_2 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "DNS2 o3"  ; id: dns2_3 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true
  - platform: template
    name: "DNS2 o4"  ; id: dns2_4 ; min_value: 0 ; max_value: 255 ; step: 1 ; restore_value: true

button:
  - platform: template
    name: "Guardar IP i Reiniciar"
    id: save_and_reboot
    on_press:
      - lambda: |-
          ESP.restart();

text_sensor:
  - platform: version
    name: "Versió de Firmware"

sensor:
  - platform: ethernet_info
    ip_address:
      name: "IP Ethernet"
