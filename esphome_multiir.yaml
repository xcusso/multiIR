# Versió RC00
esphome:
  name: multi-ir
  friendly_name: Multi_ir

esp32:
  board: esp32dev
  framework:
    type: esp-idf

logger:

api:
  encryption:
    key: !secret api_key

ota:
  - platform: esphome
    password: !secret ota_password
    
globals:
# Globals de selecció
  - id: selected_tv
    type: int
    restore_value: no
    initial_value: '1'        # TV1 per defecte
    
  - id: selected_protocol
    type: int
    restore_value: no
    initial_value: '3'        # Protocol 3 (RC6) per defecte

# Guardem quatre valors de protocol    
  - id: protocol_tv1
    type: int
    restore_value: yes
    initial_value: '3'        # 1=NEC, 2=RC5, 3=RC6 (per defecte RC6)
  - id: protocol_tv2
    type: int
    restore_value: yes
    initial_value: '3'        # 1=NEC, 2=RC5, 3=RC6 (per defecte RC6)   
  - id: protocol_tv3
    type: int
    restore_value: yes
    initial_value: '3'        # 1=NEC, 2=RC5, 3=RC6 (per defecte RC6) 
  - id: protocol_tv4
    type: int
    restore_value: yes
    initial_value: '3'        # 1=NEC, 2=RC5, 3=RC6 (per defecte RC6) 
    
  - id: selected_function
    type: int
    restore_value: no
    initial_value: '1'        # Funció 1 per defecte   

# ---------- Ethernet principal (WT32‑ETH01: LAN8720) ----------
ethernet:
  type: LAN8720
  mdc_pin: GPIO23
  mdio_pin: GPIO18
  clk_mode: GPIO0_IN
  phy_addr: 1
  power_pin: GPIO16
  # DHCP per defecte; si hi ha IP guardada, s'aplica a on_boot via ETH.config()

# ---------- Wi‑Fi només com AP de configuració ----------
wifi:
  ap:
    ssid: "multiIR-setup"
    password: "12345678"

captive_portal:

# ---------- Pàgina web de configuració (IP, GW, SN, DNS, SSID/PASS) ----------
web_server:
  port: 80
  
text_sensor:
### Retorna els protocols de cada TV
  - platform: template
    name: "TV1 protocol"
    lambda: |-
      switch (id(protocol_tv1)) {
        case 1: return {"NEC"};
        case 2: return {"RC5"};
        case 3: return {"RC6"};
        case 4: return {"Sony"};
        case 5: return {"Samsung"};
        case 6: return {"LG"};
        case 4: return {"Panasonic"};
        case 8: return {"RAW/PRONTO"};
        default: return {"(no definit)"};
      }

  - platform: template
    name: "TV2 protocol"
    lambda: |-
      switch (id(protocol_tv2)) {
        case 1: return {"NEC"};
        case 2: return {"RC5"};
        case 3: return {"RC6"};
        case 4: return {"Sony"};
        case 5: return {"Samsung"};
        case 6: return {"LG"};
        case 4: return {"Panasonic"};
        case 8: return {"RAW/PRONTO"};
        default: return {"(no definit)"};
      }

  - platform: template
    name: "TV3 protocol"
    lambda: |-
      switch (id(protocol_tv3)) {
        case 1: return {"NEC"};
        case 2: return {"RC5"};
        case 3: return {"RC6"};
        case 4: return {"Sony"};
        case 5: return {"Samsung"};
        case 6: return {"LG"};
        case 4: return {"Panasonic"};
        case 8: return {"RAW/PRONTO"};
        default: return {"(no definit)"};
      }

  - platform: template
    name: "TV4 protocol"
    lambda: |-
      switch (id(protocol_tv4)) {
        case 1: return {"NEC"};
        case 2: return {"RC5"};
        case 3: return {"RC6"};
        case 4: return {"Sony"};
        case 5: return {"Samsung"};
        case 6: return {"LG"};
        case 4: return {"Panasonic"};
        case 8: return {"RAW/PRONTO"};
        default: return {"(no definit)"};
      }

# =========================================================
# =                BLOC IR MULTI-SORTIDA                 =
# =========================================================



# QUATRE emissors IR
remote_transmitter:
  - id: ir_tv1
    pin: GPIO14     # GPIO per TV1
    carrier_duty_percent: 50%
  - id: ir_tv2
    pin: GPIO12     # GPIO per TV2
    carrier_duty_percent: 50%
  - id: ir_tv3
    pin: GPIO04     # GPIO per TV3
    carrier_duty_percent: 50%
  - id: ir_tv4
    pin: GPIO02     # GPIO per TV4
    carrier_duty_percent: 50%

# -------------------------------
# Botons: Selecció de TV (4)
# -------------------------------
button:
  - platform: template
    name: "Selecciona TV1"
    id: sel_tv_1
    on_press:
      then: 
        - lambda: |- 
            id(selected_tv) = 1;
            id(selected_protocol) = id(protocol_tv1);

        
  - platform: template
    name: "Selecciona TV2"
    id: sel_tv_2
    on_press: 
      then: 
        - lambda: |- 
            id(selected_tv) = 2;
            id(selected_protocol) = id(protocol_tv2);
            
  - platform: template
    name: "Selecciona TV3"
    id: sel_tv_3
    on_press:
      then: 
        - lambda: |- 
            id(selected_tv) = 3;
            id(selected_protocol) = id(protocol_tv3);

  - platform: template
    name: "Selecciona TV4"
    id: sel_tv_4
    on_press: 
      then: 
        - lambda: |- 
            id(selected_tv) = 4;
            id(selected_protocol) = id(protocol_tv4);

# -------------------------------
# Botons: Selecció de protocol (8)
# 1=NEC, 2=RC5, 3=RC6, 4..8 placeholders
# -------------------------------
  - platform: template
    name: "Protocol NEC"
    id: P01
    on_press:
      then:
        - lambda: |-
            if (id(selected_tv) == 1) {
            id(protocol_tv1) = 1;
            } else if (id(selected_tv) == 2) {
            id(protocol_tv2) = 1;
            } else if (id(selected_tv) == 3) {
            id(protocol_tv3) = 1;
            } else if (id(selected_tv) == 4) {
            id(protocol_tv4) = 1}

  - platform: template
    name: "Protocol RC5"
    id: P02
    on_press:
      then:
        - lambda: |-
            if (id(selected_tv) == 1) {
            id(protocol_tv1) = 2;
            } else if (id(selected_tv) == 2) {
            id(protocol_tv2) = 2;
            } else if (id(selected_tv) == 3) {
            id(protocol_tv3) = 2;
            } else if (id(selected_tv) == 4) {
            id(protocol_tv4) = 2}

  - platform: template
    name: "Protocol RC6"
    id: P03
    on_press:
      then:
        - lambda: |-
            if (id(selected_tv) == 1) {
            id(protocol_tv1) = 3;
            } else if (id(selected_tv) == 2) {
            id(protocol_tv2) = 3;
            } else if (id(selected_tv) == 3) {
            id(protocol_tv3) = 3;
            } else if (id(selected_tv) == 4) {
            id(protocol_tv4) = 3}

  - platform: template
    name: "Protocol Sony"
    id: P04
    on_press:
      then:
        - lambda: |-
            if (id(selected_tv) == 1) {
            id(protocol_tv1) = 4;
            } else if (id(selected_tv) == 2) {
            id(protocol_tv2) = 4;
            } else if (id(selected_tv) == 3) {
            id(protocol_tv3) = 4;
            } else if (id(selected_tv) == 4) {
            id(protocol_tv4) = 4}            

  - platform: template
    name: "Protocol Samsung"
    id: P05
    on_press:
      then:
        - lambda: |-
            if (id(selected_tv) == 1) {
            id(protocol_tv1) = 5;
            } else if (id(selected_tv) == 2) {
            id(protocol_tv2) = 5;
            } else if (id(selected_tv) == 3) {
            id(protocol_tv3) = 5;
            } else if (id(selected_tv) == 4) {
            id(protocol_tv4) = 5}            
                      
  - platform: template
    name: "Protocol LG"
    id: P06
    on_press:
      then:
        - lambda: |-
            if (id(selected_tv) == 1) {
            id(protocol_tv1) = 6;
            } else if (id(selected_tv) == 2) {
            id(protocol_tv2) = 6;
            } else if (id(selected_tv) == 3) {
            id(protocol_tv3) = 6;
            } else if (id(selected_tv) == 4) {
            id(protocol_tv4) = 6}     

  - platform: template
    name: "Protocol Panasonic"
    id: P07
    on_press:
      then:
        - lambda: |-
            if (id(selected_tv) == 1) {
            id(protocol_tv1) = 7;
            } else if (id(selected_tv) == 2) {
            id(protocol_tv2) = 7;
            } else if (id(selected_tv) == 3) {
            id(protocol_tv3) = 7;
            } else if (id(selected_tv) == 4) {
            id(protocol_tv4) = 7}

  - platform: template
    name: "Protocol RAW/Pronto"
    id: P08
    on_press:
      then:
        - lambda: |-
            if (id(selected_tv) == 1) {
            id(protocol_tv1) = 8;
            } else if (id(selected_tv) == 2) {
            id(protocol_tv2) = 8;
            } else if (id(selected_tv) == 3) {
            id(protocol_tv3) = 8;
            } else if (id(selected_tv) == 4) {
            id(protocol_tv4) = 8}


# BoTONS 
  - platform: template
    name: "ON"
    id: b_on
    on_press:
      then:
        - lambda: |-
            using namespace esphome::remote_base;

            const int tv    = id(selected_tv);
            const int proto = id(selected_protocol);

            // Validació bàsica
            if (tv < 1 || tv > 4) {
              ESP_LOGW("IR", "TV fora de rang: %d", tv);
              return;
            }

            // Triar transmissor segons TV
            auto &tx = (tv == 1) ? id(ir_tv1)
                       : (tv == 2) ? id(ir_tv2)
                       : (tv == 3) ? id(ir_tv3)
                                   : id(ir_tv4);

            auto call = tx.transmit();
            ESP_LOGI("IR", "ON: TV=%d, proto=%d", tv, proto);

            if (proto == 3) {            // RC6
              // Alternança del bit toggle per ser “més realistes”
              static uint8_t toggle = 0;

              RC6Data d{};
              d.mode    = 0;
              d.toggle  = toggle;
              d.address = 0x00;          // Philips acostuma a 0x00
              d.command = 0x0C;          // PowerToggle
              RC6Protocol().encode(call.get_data(), d);
              call.perform();

              toggle ^= 1;               // canvia el bit per la pròxima vegada

            } else if (proto == 2) {     // RC5 (exemple)
              RC5Data d{};
              d.toggle  = 0;             // pots alternar si ho vols
              d.address = 0x00;          // adapta a la teva TV
              d.command = 0x3F;          // exemple de Power
              RC5Protocol().encode(call.get_data(), d);
              call.perform();

            } else {
              ESP_LOGW("IR", "Protocol no implementat: %d", proto);
            }
          

 - remote_transmitter.transmit_rc6:
                        transmitter_id: ir_tv1
                        address: 0x00   # Philips acostuma a 0x00
                        command: !lambda |-
                          // Mapa de 20 funcions -> comandes RC6 (TV1)
                          // Valors extrets del fil (Philips 65OLED803, RC6)  (PowerToggle=0x0C, Vol+=0x10, Vol-=0x11, Mute=0x0D, Ch+=0x20, Ch-=0x21, Up=0x58, Down=0x59, Left=0x5A, Right=0x5B, OK=0x5C, Home=0x54, Source=0x38, Menu=0x57, Exit=0x9F, Netflix=0x76, Stop=0x31, Play=0x2C, Pause=0x30, FF=0x28)
                          const uint8_t idx = id(selected_function);
                          static const uint8_t cmd[21] = {
                            0x00, // 0 (no s'usa)
                            0x0C, // 1  PowerToggle
                            0x10, // 2  VolumeUp
                            0x11, // 3  VolumeDown
                            0x0D, // 4  Mute
                            0x20, // 5  ChannelUp
                            0x21, // 6  ChannelDown
                            0x58, // 7  Up
                            0x59, // 8  Down
                            0x5A, // 9  Left
                            0x5B, // 10 Right
                            0x5C, // 11 OK
                            0x54, // 12 Home (SmartMenu)
                            0x38, // 13 Source
                            0x57, // 14 Menu
                            0x9F, // 15 Exit
                            0x76, // 16 Netflix
                            0x31, // 17 Stop
                            0x2C, // 18 Play
                            0x30, // 19 Pause
                            0x28  // 20 FastForward
                          };
                          return cmd[(idx <= 20) ? idx : 0];


      
        - lambda: |-
            if (id(selected_tv) == 1) & (id(protocol_tv1) == 3 {
            - lo
            if (id(protocol_tv1) = 8;
            } else if (id(selected_tv) == 2) {
            id(protocol_tv2) = 8;
            } else if (id(selected_tv) == 3) {
            id(protocol_tv3) = 8;
            } else if (id(selected_tv) == 4) {
            id(protocol_tv4) = 8}           



# -------------------------------
# Botons: 20 funcions
# cadascun guarda l'índex i crida l'script principal
# -------------------------------
{% for i in range(1,21) %}
  - platform: template
    name: "Funció {{ '%02d' % i }}"
    on_press:
      then:
        - lambda: |-
            if (id(selected_tv) == 1) {
            id(selected_protocol) = id(protocol_tv1);
            } else if (id(selected_tv) == 2) {
             id(selected_protocol) = id(protocol_tv2);;
            } else if (id(selected_tv) == 3) {
             id(selected_protocol) = id(protocol_tv3);;
            } else if (id(selected_tv) == 4) {
             id(selected_protocol) = id(protocol_tv4);}
        - globals.set: { id: selected_function, value: '{{ i }}' }
        - script.execute: send_ir
{% endfor %}





